/*! angular-wakanda - v0.4.2 - 2014-12-22 */!function(a,b){function c(a){var b=new Date;return b.setISO(a),b}function d(a){if(null==a||""==a)return null;var b=a.split("!");return b.length<3?null:new Date(Number(b[2]),Number(b[1])-1,Number(b[0]))}b["true"]=a;var f;!function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;f=function(){},f.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}();var g={core:{},config:{}};Date.prototype.toJSON=function(){return this.toISO()+","+this.toSimpleDateString()},Date.prototype.toSimpleDateString=function(){return""+this.getDate()+"!"+(this.getMonth()+1)+"!"+(this.getYear()+1900)},Date.prototype.setISO=function(a){var b="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",c=a.match(new RegExp(b)),d=0,e=new Date(c[1],0,1);c[3]&&e.setMonth(c[3]-1),c[5]&&e.setDate(c[5]),c[7]&&e.setHours(c[7]),c[8]&&e.setMinutes(c[8]),c[10]&&e.setSeconds(c[10]),c[12]&&e.setMilliseconds(1e3*Number("0."+c[12])),c[14]&&(d=60*Number(c[16])+Number(c[17]),d*="-"==c[15]?1:-1),d-=e.getTimezoneOffset(),time=Number(e)+60*d*1e3,this.setTime(Number(time))},Date.prototype.toISO=function(a,b){if(!a)var a=6;if(b){var c=b.match(/([-+])([0-9]{2}):([0-9]{2})/),d=60*Number(c[2])+Number(c[3]);d*="-"==c[1]?-1:1;var e=new Date(Number(Number(this)+6e4*d))}else var b="Z",e=this;var f=function(a){return(10>a?"0":"")+a},g="";if(g+=e.getUTCFullYear(),a>1&&(g+="-"+f(e.getUTCMonth()+1)),a>2&&(g+="-"+f(e.getUTCDate())),a>3&&(g+="T"+f(e.getUTCHours())+":"+f(e.getUTCMinutes())),a>5){var h=Number(e.getUTCSeconds()+"."+(e.getUTCMilliseconds()<100?"0":"")+f(e.getUTCMilliseconds()));g+=":"+f(h)}else a>4&&(g+=":"+f(e.getUTCSeconds()));return a>3&&(g+=b),g},Date.prototype.isValid=function(){return!isNaN(this.getTime())},g.core.restConnect={},g.core.restConnect.httpMethods={_post:"POST",_get:"GET",_put:"PUT",_delete:"DELETE"},g.core.restConnect.restActions={_retrieve:"retrieve",_create:"create",_update:"update",_delete:"delete"},g.core.restConnect.queryOptions={_expand:"$expand",_orderby:"$orderby",_skip:"$skip",_top:"$top",_filter:"$filter"},g.core.restConnect.filterOperators={_equal:"eq",_notequal:"neq",_greaterthan:"gt",_greaterthanorequal:"gteq",_lessthan:"lt",_lessthanorequal:"lteq",_logicaland:"and",_logicalor:"or",_logicalnot:"not"},g.core.restConnect.filterArithmeticOperators={_add:"add",_sub:"sub",_mul:"mul",_div:"div",_mod:"mod"},g.core.restConnect.defaultService="rest",g.core.restConnect.standardErrors={_hostnamemissing:{key:"1",string:"The hostname is missing."},_servicemissing:{key:"2",string:"The service is missing."},_httpmethodundefined:{key:"3",string:"The HTTP method is undefined."},_wronghttpmethod:{key:"4",string:"The HTTP method get doesn't support POST data."}},g.core.restConnect.getXMLHttpRequest=function(){var a=!1;return window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject,a},g.core.restConnect.restRequest=function(a){this.connectionMode=a,this.fullURL=null,this.httpMethod=g.core.restConnect.httpMethods._get,this.hostname="",this.app=g.config.pattern,this.service=g.core.restConnect.defaultService,this.resource="",this.attributesRequested=void 0,this.keys=[],this.expand=[],this.orderby=[],this.skip=null,this.top=null,this.filter=null,this.method=null,this.metadata=null,this.handler=null,this.postdata=null,this.queryPlan=null,this.progressInfo=null,this.distinct=!1,this.refreshOnly=!1,this.error={key:0,string:""},this.orderByArgsToString=function(){var a="";if("string"==typeof this.orderby)return this.orderby;this.orderby.length>0&&(a=this.orderby[0]);for(var b=1;b<this.orderby.length;b++)a+=","+this.orderby[b];return a},this.go=function(a){var b=this.handler,c="/";if(null!=this.app&&(c+=this.app+"/"),""===this.service)return this.error=g.core.restConnect.standardErrors._servicemissing,!1;if(c+=this.service+"/",""!==this.resource&&(c+=this.resource+"/",this.keys.length>0)){c+="(";for(var d=0;d<this.keys.length;d++)c+=this.keys[d],d<this.keys.length-1&&(c+=",");c+=")"}var e=!1;this.dataURI&&(c=this.dataURI,e=-1!==c.indexOf("?"),e||(c+="/"));var f=!e;if(void 0!=this.attributesRequested){if(this.attributesRequested.length>0){c+=this.attributesRequested[0];for(var d=1;d<this.attributesRequested.length;d++)c+=","+this.attributesRequested[d]}c+="/"}var h="";if(this.skip&&(h+=(e?"&$skip=":"$skip=")+this.skip,e=!0),this.top&&(h+=(e?"&$top=":"$top=")+this.top,e=!0),this.filter&&(h+=(e?"&$filter=":"$filter=")+encodeURIComponent("'"+this.filter+"'"),e=!0),this.params&&(h+=(e?"&$params=":"$params=")+encodeURIComponent("'"+JSON.stringify(this.params)+"'"),e=!0),this.method&&(h+=(e?"&$method=":"$method=")+this.method,e=!0),this.asArray&&(h+=(e?"&$asArray=":"$asArray=")+"true",e=!0),this.metadata&&(h+=(e?"&$metadata=":"$metadata=")+this.metadata,e=!0),null!=this.mustlock&&(h+=(e?"&$lock=":"$lock=")+this.mustlock,e=!0),this.distinct&&(h+=(e?"&$distinct=":"$distinct=")+this.distinct,e=!0),null!=this.findKey&&(h+=(e?"&$findKey=":"$findKey=")+encodeURIComponent(""+this.findKey),e=!0),null!=this.reselect&&(h+=(e?"&$reselect=":"$reselect=")+encodeURIComponent(""+this.reselect),e=!0),this.queryPlan&&(h+=e?"&$queryplan=true&querypath=true":"$queryplan=true&querypath=true",e=!0),this.progressInfo&&(h+=(e?"&$progressinfo=":"$progressinfo=")+encodeURIComponent(this.progressInfo),e=!0),this.timeout&&(h+=(e?"&$timeout=":"$timeout=")+this.timeout,e=!0),this.savedQueryString&&(h+=(e?"&$savedfilter=":"$savedfilter=")+encodeURIComponent("'"+this.savedQueryString+"'"),e=!0),this.savedOrderby&&(h+=(e?"&$savedorderby=":"$savedorderby=")+this.savedOrderby,e=!0),this.refreshOnly&&(h+=(e?"&$refresh=":"$refresh=")+this.refreshOnly,e=!0),this.atOnce&&(h+=(e?"&$atOnce=":"$atOnce=")+this.atOnce,e=!0),this.retainPositions&&(h+=(e?"&$retainPositions=":"$retainPositions=")+this.retainPositions,e=!0),null!=this.removeAtPos&&(h+=(e?"&$removeFromSet=":"$removeFromSet=")+this.removeAtPos,e=!0),null!=this.removeReferenceOnly&&(h+=(e?"&$removeRefOnly=":"$removeRefOnly=")+this.removeReferenceOnly,e=!0),null!=this.filterAttributes&&(h+=(e?"&$attributes=":"$attributes=")+encodeURIComponent(this.filterAttributes),e=!0),null!=this.addToSet&&(h+=(e?"&$addToSet=":"$addToSet=")+encodeURIComponent("'"+JSON.stringify(this.addToSet)+"'"),e=!0),null!=this.fromSelection&&(h+=(e?"&$fromSel=":"$fromSel=")+encodeURIComponent("'"+JSON.stringify(this.fromSelection)+"'"),e=!0),null!=this.keepSelection&&(h+=(e?"&$keepSel=":"$keepSel=")+encodeURIComponent("'"+JSON.stringify(this.keepSelection)+"'"),e=!0),this.orderby&&this.orderby.length&&(h+=e?"&$orderby="+this.orderByArgsToString():"$orderby="+this.orderByArgsToString(),e=!0),null!=this.subOrderby&&(h+=(e?"&$subOrderby=":"$subOrderby=")+encodeURIComponent(this.subOrderby),e=!0),void 0!=this.attributesExpanded&&this.attributesExpanded.length>0){var i="";h+=e?"&$expand=":"$expand=",e=!0;for(var d=0;d<this.attributesExpanded.length;d++)i+=""===i?this.attributesExpanded[d]:","+this.attributesExpanded[d];h+=i}null!=this.autoExpand&&""!=this.autoExpand&&(h+=e?"&$expand=":"$expand=",e=!0,h+=this.autoExpand),null!=this.autoSubExpand&&""!=this.autoSubExpand&&(h+=e?"&$subExpand=":"$subExpand=",e=!0,h+=this.autoSubExpand),""!==h&&(f&&(c+="?"),c+=h);var j="";if(""!==this.httpMethod?j=this.httpMethod:this.error=g.core.restConnect.httpMethods._get,this.postdata&&j==g.core.restConnect.httpMethods._get)return this.error=g.core.restConnect.standardErrors._wronghttpmethod,!1;if(this.http_request=g.core.restConnect.getXMLHttpRequest(),this.http_request){if(this.http_request.parent=this,a&&a.generateRESTRequestOnly)return c;null!=b&&(this.http_request.onreadystatechange=function(){b(this.parent)});try{return this.fullURL&&(c=this.fullURL),this.http_request.open(j,c,this.connectionMode),this.postdata&&this.http_request.setRequestHeader("Content-Type","application/json"),this.http_request.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),this.http_request.setRequestHeader("Cache-Control","no-cache"),this.http_request.send(this.postdata),this.connectionMode||b(this.http_request),!0}catch(k){return!0}return!1}}},g.callHandler=function(a,b,c,d,e){var f=null;if(c.userData=e,a){var g=d.onError;c.error=b,null!=g&&(f=g(c))}else{var h=d.onSuccess;null!=h&&(f=h(c))}return f},g.getRequestResult=function(a){var b,c=a.http_request.responseText;if(null==c)b={__ERROR:[{errCode:-1}]};else try{b=JSON.parse(c)}catch(d){b={__ERROR:[d]}}return b},g.tools={},g.tools.optionMatchers=["onSuccess","onError","atTheEnd","sync","autoExpand","autoSubExpand","catalog","queryString","skip","top","position","orderby","orderBy","params","queryPlan","queryPath","pageSize","filterSet","progressInfo","progressBar","delay","delayInfo","method","first","limit","userData","addToSet","atOnce","refreshOnly","keepOldCollectionOnError","isMethodResult","prefetchedData","callWithGet","generateRESTRequestOnly","forceReload","doNotAlterElemPos","overrideStamp","queryParams","createEmptyCollection","forceCollectionRefresh","refreshCollectionFrom","removeReferenceOnly","timeout","doNotDispatch","destinationDataSource","filterAttributes","subOrderby","filterQuery","withinCollection","keepOrderBy","retainPositions","fromInitialQuery","reselect"],g.tools.isOptionParam=function(a){var b=!1;if(null!=a&&"object"==typeof a)for(var c=g.tools.optionMatchers,d=c.length,e=0;d>e&&!b;++e){var f=c[e];if(f in a){b=!0;break}}return b},g.tools.handleArgs=function(a,b,c){var d=!1;c=c||{},b=b||0;var e,f=c.noUserData||!1,h=c.with3funcs||!1,i=c.queryParams||!1,j={options:{},userData:null},k=a.length,l=b;k>l&&(e=a[l],"function"==typeof e&&(j.options.onSuccess=e,++l,k>l&&(e=a[l],"function"==typeof e&&(j.options.onError=e,++l,k>l&&(e=a[l],h&&"function"==typeof e&&(j.options.atTheEnd=e,++l)))),null==j.options.onError&&(j.options.onError=j.options.onSuccess)));var m=null;i&&(m=[]);do if(k>l)if(e=a[l],!d&&g.tools.isOptionParam(e)){d=!0,++l;var n=j.options;j.options=e,null!=n.onSuccess&&(j.options.onSuccess=n.onSuccess),null!=n.onError&&(j.options.onError=n.onError),null!=n.atTheEnd&&(j.options.atTheEnd=n.atTheEnd),i||k>l&&!f&&(j.userData=a[l],++l)}else i&&("object"!=typeof e||e instanceof Date||e instanceof Array?(m.push(e),++l):(j.userData=e,++l));while(i&&k>l);return null!=j.options.userData&&null==j.userData&&(j.userData=j.options.userData),i&&(j.options.params=j.options.params||m),j.nextParam=l,j},g.EntityCache=function(a){a=a||{};this.maxEntities=a.maxEntities||300,this.timeOut=a.timeOut||3e5,this.entitiesByKey={},this.nbEntries=0,this.curStamp=0},g.EntityCache.prototype.getNextStamp=function(){var a=this;return a.curStamp++,a.curStamp},g.EntityCache.prototype.clear=function(a){var b=this;if(null==a||a>=b.nbEntries)b.entitiesByKey={},b.nbEntries=0;else{var c=[],d=b.entitiesByKey;for(var e in d)c.push(d[e]);c.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1});var f=a;f>c.length&&(f=c.length);for(var g=b.nbEntries,h=0;f>h;h++){var i=c[h];delete d[i.key],--g}b.nbEntries=g,delete c}},g.EntityCache.prototype.makeRoomFor=function(a){var b=this;b.maxEntities<2*a&&(b.maxEntities=2*a);var c=b.maxEntities-b.nbEntries;a>c&&b.clear(a-c)},g.EntityCache.prototype.setEntry=function(a,b,c){function d(a,b){for(e in b){var c=a[e];null==c?a[e]=b[e]:null!=c.__deferred&&(a[e]=b[e])}return a}var f=this,g=f.entitiesByKey,h=g[a];if(null==h)f.nbEntries>=f.maxEntities&&f.clear(Math.round(f.nbEntries/3)),f.nbEntries++;else{var i=-1,j=null;null!=b&&(j=b.__STAMP),null!=h.rawEntity&&(i=h.rawEntity.__STAMP),i===j&&(b=d(b,h.rawEntity))}var k=f.getNextStamp();return g[a]={key:a,timeStamp:c,rawEntity:b,stamp:k},k},g.EntityCache.prototype.getCacheInfo=function(a){var b=this,c=b.entitiesByKey[a];return c},g.EntityCache.prototype.replaceCachedEntity=function(a,b){var c=this,d=c.entitiesByKey[a];null!=d&&(d.timeStamp=new Date,d.rawEntity=b,d.stamp=c.getNextStamp())},g.EntityCache.prototype.removeCachedEntity=function(a){var b=this,c=b.entitiesByKey[a];null!=c&&delete b.entitiesByKey[a]},g.EntityCache.prototype.setSize=function(a){(null==a||300>a)&&(a=300),this.maxEntities=a},g.EntityRefCache=function(a){a=a||{};this.maxEntities=a.maxEntities||300,this.timeOut=a.timeOut||3e5,this.entitiesByKey={},this.nbEntries=0,this.curStamp=0},g.EntityRefCache.prototype.clear=function(a){var b=this;if(null==a||a>=b.nbEntries)b.entitiesByKey={},b.nbEntries=0;else{var c=[],d=b.entitiesByKey;for(var e in d)c.push(d[e]);c.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1});var f=a;f>c.length&&(f=c.length);for(var g=b.nbEntries,h=0;f>h;h++){var i=c[h];delete d[i.key],--g}b.nbEntries=g,delete c}},g.EntityRefCache.prototype.makeRoomFor=function(a){var b=this;b.maxEntities<2*a&&(b.maxEntities=2*a);var c=b.maxEntities-b.nbEntries;a>c&&b.clear(a-c)},g.EntityRefCache.prototype.setEntry=function(a){var b=a.getKey();if(null!=b){var c=this,d=c.entitiesByKey,e=d[b],f=new Date;null==e?(c.nbEntries>=c.maxEntities&&c.clear(Math.round(c.nbEntries/3)),c.nbEntries++,d[b]={key:b,timeStamp:f,entity:a}):(e.entity!==a&&c.mergeEntity(e.entity,a),e.timeStamp=f)}},g.EntityRefCache.prototype.mergeEntity=function(a,b){a._private.stamp=b._private.stamp,a._private.touched=!1;var c=a._private.values,d=b._private.values,e=a._private.dataClass._private.attributesByName;for(var f in e){var g=d[f]||null;null==g?(delete c[f],delete a[f]):(c[f]=g,a[f]=g)}},g.EntityRefCache.prototype.getCacheInfo=function(a){var b=this,c=b.entitiesByKey[a];return c},g.EntityRefCache.prototype.removeCachedEntity=function(a){var b=this,c=b.entitiesByKey[a];null!=c&&delete b.entitiesByKey[a]},g.EntityRefCache.prototype.setSize=function(a){(null==a||300>a)&&(a=300),this.maxEntities=a},g.DataStore=function(a,b){a=a||{},b=b;var c=this;this._private={owner:this,dataClasses:{},dataClassesByCollectionName:{},ready:!1,cacheRef:a.cacheRef||!1,getCatalog:g.DataStore.getCatalog},c._private.getCatalog(a,b)},g.DataStore.prototype.getDataClass=function(a){var b=this._private,c=b.dataClasses[a];return null==c&&(c=b.dataClassesByCollectionName[a]),c},g.DataStore.prototype.getDataClasses=function(){var a=this._private;return a.dataClasses},g.DataStore.prototype.mustCacheRef=function(){return this._private.cacheRef},g.DataStore.prototype.addToCatalog=function(a,b,c){c=c||null,b=b||{};var d=this._private;b.catalog=a,b.mergeCatalog=!0,d.getCatalog(b,c)},g.DataStore.resolveRelatedAttribute=function(){if(!this.resolved){var a=this.owner.getDataStore();this.relatedClass=a.getDataClass(this.type),null!=this.relatedClass&&(this.resolved=!0)}},g.DataStore.getRelatedClassAttribute=function(){return this.resolve(),this.relatedClass},g.DataStore.handleFuncResult=function(a,b,c){var d=g.getRequestResult(a);if(null==d.__ERROR)if(null!=d.__entityModel&&(c=c.getDataStore().getDataClass(d.__entityModel)),null!=d.__KEY||null!=d.__STAMP){var e=new g.Entity(c,d,{getRefFromCache:!0});d={result:e}}else if(null!=d.__ENTITIES){var f=new g.EntityCollection(c,null,{prefetchedData:d,isMethodResult:!0});d={result:f}}return d},g.DataStore.funcCaller=function(a,b,c,d){var e=null;d=d||{};var f=d.sync||!1,h=a.callWithGet||d.callWithGet||!1,i=d.generateRESTRequestOnly||!1,j=new g.core.restConnect.restRequest(!f);j.httpMethod=h?g.core.restConnect.httpMethods._get:g.core.restConnect.httpMethods._post;var k=null,l=null,m=null,n=JSON.stringify(c);if(h?j.params=c:j.postdata=n,"entity"==a.applyTo){k=b,l=k.getDataClass(),j.attributesRequested=[a.name],j.resource=l.getName()+"(";var o=k.getKey();null!=o&&(j.resource+=o),j.resource+=")"}else"entityCollection"==a.applyTo?(m=b,l=m.getDataClass(),null!=m._private.dataURI?j.dataURI=m._private.dataURI+"/"+a.name:(j.attributesRequested=[a.name],j.resource=l.getName(),j.filter=d.queryString),j.savedQueryString=m._private.savedQuery,j.savedOrderby=m._private.savedOrderby,m._private.updateOptions(d)):"general"==a.applyTo?(j.resource=a.nameSpace,j.attributesRequested=[a.name]):(l=b,j.attributesRequested=[a.name],j.resource=l.getName());var p=d.pageSize||40;if(j.top=p,j.method="entityset",j.timeout=300,j.addToSet=d.addToSet,null!=d.autoExpand&&(j.autoExpand=d.autoExpand),null!=d.filterAttributes&&(j.filterAttributes=d.filterAttributes),f||(j.handler=function(){if(4==j.http_request.readyState){var b=g.DataStore.handleFuncResult(j,a,l),c={result:b.result},e=b.__ERROR,f=d.userData||null;c.XHR=j.http_request,g.callHandler(null!=e,e,c,d,f)}}),i)e=j.go({generateRESTRequestOnly:!0});else if(j.go(),f){var q,r;if(q=function(){},r=function(){},c.length>0&&(c[0]&&"function"==typeof c[0]&&(q=c[0]),c[1]&&"function"==typeof c[1]&&(r=c[1])),4!=j.http_request.readyState)throw{error:401};var s=g.DataStore.handleFuncResult(j,a,l);if(null!=s.__ERROR)throw r(s),s.__ERROR;e=s.result,q(e)}return e},g.DataStore.callMethod=function(a){var b=null,c=this,d=c._private.dataClassMethodRefs[a.method];if(null!=d){var e=[];if(null!=a.arguments)e=a.arguments;else for(var f=1,h=arguments.length;h>f;f++)e.push(arguments[f]);b=g.DataStore.funcCaller(d,c,e,a)}return b},g.DataStore.makeFuncCaller=function(a){var b=a,c=function(){for(var a,c=!1,d=[],e=0,f=arguments.length;f>e;e++){var h=arguments[e];!c&&g.tools.isOptionParam(h)?(a=h,c=!0):d.push(h)}var i=a||{};return void 0===i.onSuccess&&void 0===i.onError&&void 0===i.generateRESTRequestOnly&&(i.sync=!0),g.DataStore.funcCaller(b,this,d,i)};return c},g.DataStore.getCatalog=function(a,b){var c=this,d=this.owner,e=g.tools.handleArgs(arguments,0);b=e.userData,a=e.options;var f=a.mergeCatalog||!1,h=!1,i="$all";if(c.cacheRef=c.cacheRef||a.cacheRef||!1,null!=a.catalog&&(i="string"==typeof a.catalog?a.catalog:a.catalog.join(","),f&&(classList=i.split(","),newlist=[],classList.forEach(function(a){""!=a&&null==d[a]&&newlist.push(a)}),0==newlist.length&&(h=!0))),h){var j={dataStore:d,result:d};g.callHandler(!1,null,j,a,b)}else{i="$catalog/"+i;var k=new g.core.restConnect.restRequest(!0);k.resource=i,k.handler=function(){if(4==k.http_request.readyState){var e=!1,f=null,h=null;try{var i=g.getRequestResult(k);i&&i.dataClasses?f=i.dataClasses:i&&i.className&&(f=[i]),null==f&&(f=[]),null!=i.__ERROR&&(e=!0,h=i.__ERROR)}catch(j){f=[],e=!0,h=j}for(var l=0,m=f.length;m>l;l++){var n=f[l],o=n.name;if(null==d[o]){var p=n.collectionName,q=new g.DataClass(n,d);c.dataClasses[o]=q,null!=p&&(c.dataClassesByCollectionName[p]=q),d[o]=q}}c.ready=!0;var r={dataStore:d,result:d};r.XHR=k.http_request,g.callHandler(e,h,r,a,b)}};{k.go()}}},g.DataClass=function(a,b){var c=this,d="";a.key&&(d=a.key[0].name),c._private={primaryKey:d,className:a.name,collectionName:a.collectionName,attributesByName:{},entityMethods:{},entityCollectionMethods:{},entityMethodRefs:{},entityCollectionMethodRefs:{},dataClassMethodRefs:{},owner:c,dataStore:b,cache:new g.EntityCache,refCache:new g.EntityRefCache,defaultTopSize:a.defaultTopSize,getEntityByURIOrKey:g.DataClass.getEntityByURIOrKey};var e=c._private,f=e.attributesByName,h=e.dataClassMethodRefs,i=e.entityCollectionMethodRefs,j=e.entityMethodRefs,k=e.entityCollectionMethods,l=e.entityMethods,m=a.attributes,n=a.methods;if(e.methods=n,null!=m)for(var o=0,p=m.length;p>o;o++){var q=m[o];q.owner=c,f[q.name]=q,"storage"==q.kind||"calculated"==q.kind||"alias"==q.kind||"composition"==q.kind?(q.simple=!0,q.related=!1,("image"==q.type||"blob"==q.type)&&(q.simple=!1)):(q.simple=!1,q.related=!0,q.resolved=!1,q.relatedOne="relatedEntity"==q.kind,q.resolve=g.DataStore.resolveRelatedAttribute,q.getRelatedClass=g.DataStore.getRelatedClassAttribute,q.relatedClass=null),c[q.name]=q}e.attributes=m;var r=n;if(null!=r)for(var o=0,s=r.length;s>o;o++){var t=r[o];"entity"==t.applyTo?(j[t.name]=t,l[t.name]=g.DataStore.makeFuncCaller(t)):"entityCollection"==t.applyTo?(i[t.name]=t,k[t.name]=g.DataStore.makeFuncCaller(t)):(h[t.name]=t,c[t.name]=g.DataStore.makeFuncCaller(t))}return this},g.DataClass.getEntityByURIOrKey=function(a,b,c,d){var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f=this,h=f.owner,i=new g.core.restConnect.restRequest(!0);null!=b?i.fullURL=b:i.resource=h.getName()+"("+a+")",i.autoExpand=c.autoExpand,i.autoSubExpand=c.autoSubExpand,i.filterAttributes=c.filterAttributes,i.handler=function(){if(4==i.http_request.readyState){var a=!1,b=null,e=g.getRequestResult(i);null!=e.__ERROR&&(a=!0,b=e.__ERROR);var f=null;if(!a){var j=h.mustCacheRef();if(f=new g.Entity(h,e,{getRefFromCache:j}),!j){var k=f.getKey(),l=h.getCache(),m=l.getCacheInfo(k);if(null==m){var n=new Date;l.setEntry(k,e,n)}else l.replaceCachedEntity(k,e)}}var o={entity:f,result:f};o.XHR=i.http_request,g.callHandler(a,b,o,c,d)}};i.go()},g.DataClass.mustCacheRef=function(){return this._private.dataStore.mustCacheRef()},g.DataClass.getName=function(){return this._private.className},g.DataClass.getCollectionName=function(){return this._private.collectionName},g.DataClass.getDefaultTopSize=function(){return this._private.defaultTopSize},g.DataClass.getDataStore=function(){return this._private.dataStore},g.DataClass.getCache=function(){return this._private.cache},g.DataClass.getRefCache=function(){return this._private.refCache},g.DataClass.setCacheSize=function(a){var b=this._private.cacheRef?this._private.refCache:this._private.cache;b.setSize(a)},g.DataClass.getCacheSize=function(){var a=this._private.cacheRef?this._private.refCache:this._private.cache;return a.maxEntities},g.DataClass.clearCache=function(){var a=this._private.cacheRef?this._private.refCache:this._private.cache;a.clear()},g.DataClass.getAttributeByName=function(a){var b=this;return b._private.attributesByName[a]},g.DataClass.getAttributes=function(){var a=this;return a._private.attributes},g.DataClass.getMethodList=function(){var a=this;return a._private.methods},g.DataClass.newEntity=function(){var a=new g.Entity(this);return a},g.DataClass.getEntity=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;if(e.mustCacheRef()){var f,h=e.getRefCache();if(f=b.forceReload?null:h.getCacheInfo(a),null==f)e._private.getEntityByURIOrKey(a,null,b,c);else{var i=f.entity,j={entity:i,result:i},k=g.callHandler(!1,null,j,b,c);"boolean"==typeof k&&(k||null!=b&&(b.mustStopLoop=!0))}}else{var f,h=e.getCache();if(f=b.forceReload?null:h.getCacheInfo(a),null==f||null==f.rawEntity)e._private.getEntityByURIOrKey(a,null,b,c);else{var i=new g.Entity(e,f.rawEntity),j={entity:i,result:i},k=g.callHandler(!1,null,j,b,c);"boolean"==typeof k&&(k||null!=b&&(b.mustStopLoop=!0))}}},g.DataClass.newCollection=function(a,b,c){if(null==a){var d=new g.EntityCollection(this,null,{createEmptyCollection:!0});return d}var e=g.tools.handleArgs(arguments,1);c=e.userData,b=e.options,b.dataURI=a.dataURI,b.pageSize=b.pageSize||a.pageSize,b.autoExpand=b.autoExpand||a.autoExpand,b.filterAttributes=b.filterAttributes||a.filterAttributes,b.savedQuery=a.savedQuery||null,b.savedOrderby=a.savedOrderby||null;var d=new g.EntityCollection(this,null,b,c);return d},g.DataClass.getEntityByURI=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;e._private.getEntityByURIOrKey(null,a,b,c)},g.DataClass.distinctValues=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=b.queryString,f=b.skip,h=b.top,i=this,j=new g.core.restConnect.restRequest(!0);j.resource=i.getName(),j.filter=e,j.skip=f,j.top=h,j.options={objectRef:this,first:f,top:h},null!=a&&(j.attributesRequested=[a]),j.distinct=!0,j.addToSet=b.addToSet,j.handler=function(){if(4==j.http_request.readyState){var a=g.getRequestResult(j),d=!1,e=null;if(null!=a.__ERROR){e=a.__ERROR,d=!0;for(var f=0;f<a.__ERROR.length;f++){var h=a.__ERROR[f];null==h.options&&(h.options={}),h.options.position=first}}var i={result:a,distinctValues:a,XHR:j.http_request};g.callHandler(d,e,i,b,c)}},j.go()},g.DataClass.query=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,f=new g.EntityCollection(e,a,b,c);return f},g.DataClass.allEntities=function(a,b){var c=g.tools.handleArgs(arguments,0);return b=c.userData,a=c.options,this.query("",a,b)},g.DataClass.find=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,f=(this._private,new g.core.restConnect.restRequest(!0));f.resource=e.getName(),f.autoExpand=b.autoExpand,f.filterAttributes=b.filterAttributes,f.filter=a,f.top=1,f.orderby=b.orderby,f.params=b.params,f.handler=function(){if(4==f.http_request.readyState){var a=!1,d=null,h=g.getRequestResult(f);null!=h.__ERROR&&(a=!0,d=h.__ERROR);var i=null;!a&&null!=h.__ENTITIES&&h.__ENTITIES.length>0&&(i=new g.Entity(e,h.__ENTITIES[0],{getRefFromCache:!0}));var j={entity:i,result:i,XHR:f.http_request};g.callHandler(a,d,j,b,c)}};f.go()},g.DataClass.toArray=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=new g.core.restConnect.restRequest(!0);f.resource=this.getName(),f.top=b.top||null,f.skip=b.skip||null,f.addToSet=b.addToSet,f.retainPositions=b.retainPositions||null,f.progressInfo=b.progressInfo,f.orderby=b.orderby,f.autoExpand=a,f.asArray=!0,b.filterQuery&&(f.filter=b.filterQuery,f.params=b.params),f.handler=function(){if(4==f.http_request.readyState){var a=g.getRequestResult(f),d={dataClass:e,result:a,XHR:f.http_request},h=null!=a.__ERROR;g.callHandler(h,a.__ERROR,d,b,c)}};f.go()},g.EntityCollectionPage=function(a,b){this.start=a,this.length=b,this.entityKeys=[]},g.EntityCollection=function(a,b,c,d){("''"==b||""==b)&&(b=null);var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f,h=c.filterSet;null!=h?(f=h._private.savedQuery,null!=f?null!=b&&(f="("+f+") and "+b):saveQuery=b):f=b,null==f&&(f=c.savedQuery||null),null==c.orderby&&null!=c.orderBy&&(c.orderby=c.orderBy);var i=c.orderby||null;null==i&&(i=c.savedOrderby||null);var j=c.pageSize||40,k=this;this._private={ready:!1,owner:this,queryString:b,savedQuery:f,orderby:i,savedOrderby:i,dataURI:c.dataURI,pageSize:j,withQueryPlan:c.queryPlan,withQueryPath:c.queryPath,progressInfo:c.progressInfo,params:c.params,dataClass:a,methodRefs:a._private.entityCollectionMethodRefs,methods:a._private.entityCollectionMethods,autoExpand:c.autoExpand,autoSubExpand:c.autoSubExpand,filterAttributes:c.filterAttributes,isMethodResult:c.isMethodResult,isARelatedEntityCollection:c.isARelatedEntityCollection,loadedElemsLength:0,addedElems:[],curPendingStamp:0,pendingRequests:{},pages:[],clearCache:g.EntityCollection.clearCache,insertPage:g.EntityCollection.insertPage,findPage:g.EntityCollection.findPage,invalidPage:g.EntityCollection.invalidPage,getKeyByPos:g.EntityCollection.getKeyByPos,manageData:g.EntityCollection.manageData,fetchData:g.EntityCollection.fetchData,addPendingRequest:g.EntityCollection.addPendingRequest,clearPendingRequest:g.EntityCollection.clearPendingRequest,clearAllPendingRequest:g.EntityCollection.clearAllPendingRequest,isPagePending:g.EntityCollection.isPagePending,gotEntity:g.EntityCollection.gotEntity,updateOptions:g.EntityCollection.updateOptions};var l=this._private,m=l.methods;for(var n in m)k[n]=m[n];return this.length=0,c.init=!0,c.createEmptyCollection?(l.ready=!0,b="*"):null!=c.dataURI&&"*"==c.dataURI?l.ready=!0:null!=c.prefetchedData?k._private.manageData(c.prefetchedData,!0):(null==b&&null==l.savedQuery&&(l.savedQuery="$all"),k._private.fetchData(0,j,c,d)),k},g.EntityCollection.clearCache=function(){var a=this;a.pages=[]},g.EntityCollection.insertPage=function(a){var b=this,c=b.pages,d=c.length;if(0==d)c.push(a);else{for(var e=-1,f=0;d>f;f++){var g=c[f];if(g.start>a.start){e=f;break}}-1==e?c.push(a):c.splice(e,0,a)}},g.EntityCollection.findPage=function(a){for(var b=this,c=b.pages,d=c.length,e=0,f=d;f>e;){var g=Math.floor((f-e)/2)+e,h=c[g];if(h.start<=a&&h.start+h.length>a)return g;a<h.start?f=g:e=g+1}return-1},g.EntityCollection.invalidPage=function(a){var b=this,c=b.findPage(a);-1!=c&&b.pages.splice(c,1)},g.EntityCollection.getKeyByPos=function(a){var b=null,c=this,d=c.findPage(a);if(-1!=d){var e=c.pages[d],f=e.entityKeys[a-e.start];b=f.key}return b},g.EntityCollection.addPendingRequest=function(a,b){var c=this;return c.curPendingStamp++,c.pendingRequests[c.curPendingStamp]={start:a,length:b},c.curPendingStamp},g.EntityCollection.clearPendingRequest=function(a){var b=this;delete b.pendingRequests[a]},g.EntityCollection.clearAllPendingRequest=function(){var a=this;for(var b in a.pendingRequests)a.pendingRequests[b]},g.EntityCollection.isPagePending=function(a){var b=this;for(var c in b.pendingRequests){var d=b.pendingRequests[c];if(d.start<=a&&d.start+d.length>a)return!0}return!1},g.EntityCollection.manageData=function(a,b){var c,d=this,e=this.owner,f=e.getDataClass();b=b||!1,b&&(e.length=a.__COUNT,d.ready=!0,d.loadedElemsLength=e.length,d.dataURI=a.__ENTITYSET,null!=d.autoSubExpand&&(d.autoExpand=d.autoSubExpand,d.autoSubExpand=null));var h=a.__SENT,i=a.__FIRST,j=a.__ENTITIES,k=new Date,l=new g.EntityCollectionPage(i,h),m=f.mustCacheRef();c=m?f.getRefCache():f.getCache(),c.makeRoomFor(h);for(var n=0;h>n;n++){var o,p=j[n];if(null==p)m||c.setEntry("",{__STAMP:0},k),o="";else{var q=-1;if(o=p.__KEY,null==o&&(o=""),m){new g.Entity(f,p,{getRefFromCache:!0})}else q=c.setEntry(o,p,k)}l.entityKeys.push({key:p.__KEY,stamp:q})}d.insertPage(l)},g.EntityCollection.fetchData=function(a,b,c,d){var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f=c.filterSet,h=c.init||!1,i=this,j=this.owner,k=j.getDataClass(),l=(k.getCache(),i.addPendingRequest(a,b)),m=new g.core.restConnect.restRequest(!0);if(m.entityCollection=j,m.resource=i.dataClass.getName(),null!=f?null!=f._private.dataURI?(m.dataURI=f._private.dataURI,m.filter=i.queryString):m.filter=i.savedQuery:m.filter=i.queryString,m.top=b,m.skip=a,m.attributesRequested=null,m.attributesExpanded=null,m.autoExpand=i.autoExpand,m.autoSubExpand=i.autoSubExpand,m.filterAttributes=i.filterAttributes,m.params=i.params,i.mustRefreshCollectionOnNextFetch&&(m.refreshOnly=!0,i.mustRefreshCollectionOnNextFetch=!1),c.fromSelection&&(m.fromSelection=c.fromSelection),h){m.removeAtPos=c.removeAtPos,m.removeReferenceOnly=c.removeReferenceOnly,m.addToSet=c.addToSet;var n=m.fromSelection;null!=n&&(m.fromSelection=n.prepareToSend())}m.queryPlan=i.withQueryPlan,m.progressInfo=i.progressInfo,m.method=i.isARelatedEntityCollection?"subentityset":"entityset",m.timeout=c.timeout||300,m.savedOrderby=i.savedOrderby,m.savedQueryString=i.savedQuery,m.dataURI=m.dataURI||i.dataURI,m.dataURI&&null==f&&(m.filter=null),m.orderby=c.orderby,m.subOrderby=c.subOrderby,m.keepSelection=c.keepSelection,m.reselect=c.reselect,m.handler=function(){if(4==m.http_request.readyState){i.clearPendingRequest(l);var a=g.getRequestResult(m),b={entityCollection:j,result:j,XHR:m.http_request},e=null!=a.__ERROR;e||(null!=a.__transformedSelection&&(b.transformedSelection=a.__transformedSelection),i.manageData(a,h)),g.callHandler(e,a.__ERROR,b,c,d)}};m.go()},g.EntityCollection.updateOptions=function(a){var b=this;if(b.addedElems.length>0){for(var c=[],d=0,e=b.addedElems.length;e>d;d++){var f=b.addedElems[d],g=null;null!=f&&f.getKey&&(g=f.getKey()),null!=g&&c.push(g)}c.length>0&&(a.addToSet=c)}},g.EntityCollection.getDataClass=function(){var a=this;return a._private.dataClass},g.EntityCollection.getReference=function(){var a=null,b=this,c=b._private;return null!=c.dataURI&&(a={dataURI:c.dataURI},null!=c.savedQuery&&(a.savedQuery=c.savedQuery),null!=c.savedOrderby&&(a.savedOrderby=c.savedOrderby),null!=c.pageSize&&(a.pageSize=c.pageSize),null!=c.autoExpand&&(a.autoExpand=c.autoExpand)),a},g.EntityCollection.query=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this;b.filterSet=e;var f=e.getDataClass();b.pageSize=b.pageSize||e._private.pageSize,b.autoExpand=b.autoExpand||e._private.autoExpand,b.filterAttributes=b.filterAttributes||e._private.filterAttributes,e._private.updateOptions(b);
var h=new g.EntityCollection(f,a,b,c);return h},g.EntityCollection.orderBy=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;if(0==this.length){var f={entityCollection:e,result:e};return g.callHandler(!1,null,f,b,c),e}b.orderby=a;var h=e._private;b.dataURI=h.dataURI;var i=e.getDataClass();b.pageSize=b.pageSize||h.pageSize,b.autoExpand=b.autoExpand||h.autoExpand,b.filterAttributes=b.filterAttributes||h.filterAttributes,h.updateOptions(b),b.savedQuery=h.savedQuery||null;var j=new g.EntityCollection(i,null,b,c);return j},g.EntityCollection.getEntities=function(a,b,c,d){var e=this,f=e._private;if(f.ready){a+b>e.length&&(b=e.length-a);var h=g.tools.handleArgs(arguments,2);d=h.userData,c=h.options;{f.loadedElemsLength,f.addedElems.length,e.getDataClass()}f.updateOptions(c);var i=[],j={entityCollection:e,result:e,position:a,howMany:b,entities:i},k=null;e.forEach({first:a,limit:a+b,onSuccess:function(a){i.push(a.entity)},onError:function(a){k=a.error},atTheEnd:function(){null!=k?g.callHandler(!0,k,j,c,d):g.callHandler(!1,null,j,c,d)}})}else setTimeout(function(){e.getEntities(a,b,c,d)},100)},g.EntityCollection.getEntity=function(a,b,c,d){var e=!1,f=g.tools.handleArgs(arguments,1);c=f.userData,b=f.options;var h=null!=b&&(b.forceCollectionRefresh||!1);d=f.nextParam<arguments.length?arguments[f.nextParam]||!1:!1;var i=this,j=i._private,k=j.loadedElemsLength;h&&(j.clearAllPendingRequest(),j.clearCache(),j.mustRefreshCollectionOnNextFetch=!0,k=i.length);var l=i.getDataClass();if(a>=k){e=!0;var m={entityCollection:i,result:i,position:a},n=a-j.loadedElemsLength;n<j.addedElems.length?(m.entity=j.addedElems[n],g.callHandler(!1,null,m,b,c)):h?g.callHandler(!1,null,m,b,c):g.callHandler(!0,[{error:501,message:"wrong position in entityCollection"}],m,b,c)}else{var o=!1,p=j.getKeyByPos(a);if(null!=p||d||(j.isPagePending(a)?setTimeout(function(){i.getEntity(a,b,c)},100):o=!0),null!=p){var q,r=l.mustCacheRef();q=r?l.getRefCache():l.getCache();var s=q.getCacheInfo(p);null!=s?(e=!0,j.gotEntity(s,b,c,a)):(o=!0,p=null,j.invalidPage(a))}if(d&&(o=!1),null==p&&o){var t,u;if(null!=b?(t=b.delay,u=b.delayInfo):(t=null,u=null),null!=t&&0!=t&&null!=u){var v=u.findMatchingPendingRequest(a);if(null==v){var w=a-20;0>w&&(w=0),v=u.addPendingRequest(0,w,a+j.pageSize-1),v.addFetchRequest(a,b,c);var x=setTimeout(function(){if(v.matchRange(u.top,u.bottom)){var a={};h&&j.updateOptions(a),j.fetchData(v.top,v.bottom-v.top+1,{onSuccess:function(){h&&(j.addedElems=[]),v.pendingFetch.forEach(function(a){if(a.pos>=u.top&&a.pos<=u.bottom){var b,c=j.getKeyByPos(a.pos),d=l.mustCacheRef();b=d?l.getRefCache():l.getCache();var e=b.getCacheInfo(c);null!=e?j.gotEntity(e,a.options,a.userData,a.pos):j.gotEntity(null,a.options,a.userData)}}),u.removePendingRequest(v)},onError:function(a){v.pendingFetch.forEach(function(b){if(b.pos>=u.top&&b.pos<=u.bottom){var c={entityCollection:i,result:i,position:b.pos,entity:null};g.callHandler(!0,a.error,c,b.options,b.userData)}}),u.removePendingRequest(v)},init:h,addToSet:a.addToSet||null})}else u.removePendingRequest(v)},t);v.setRequestID(x)}else v.addFetchRequest(a,b,c)}else{var y={};h&&j.updateOptions(y),j.fetchData(a,j.pageSize,{onSuccess:function(){h&&(j.addedElems=[]);var d,e=j.getKeyByPos(a),f=l.mustCacheRef();d=f?l.getRefCache():l.getCache();var g=d.getCacheInfo(e);null!=g?j.gotEntity(g,b,c,a):j.gotEntity(null,b,c)},onError:function(d){var e={entityCollection:i,result:i,position:a,entity:null};g.callHandler(!0,d.error,e,b,c)},init:h,addToSet:y.addToSet||null})}}}return e},g.EntityCollection.gotEntity=function(a,b,c,d){var e,f=this,h=f.owner;e=null!=a?null!=a.entity?a.entity:new g.Entity(h.getDataClass(),a.rawEntity,{getRefFromCache:!0}):null;var i={entityCollection:h,result:e,entity:e,position:d};g.callHandler(!1,null,i,b,c)},g.EntityCollection.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,f=arguments.length;f>e;e++)d.push(arguments[e]);return g.DataStore.funcCaller(c,b,d,a)}},g.EntityCollection.parseForEach=function(a,b){for(var c=!0,d=b.entityCollection,e=(d._private,!1);c&&b.curelem<b.limit&&!e;)c=d.getEntity(b.curelem,a,b.userData,!0),null!=a&&a.mustStopLoop?e=!0:c?b.curelem++:d.getEntity(b.curelem,{onSuccess:function(){g.EntityCollection.parseForEach(a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b.userData)}},b);if(c&&null!=a.atTheEnd){var f={entityCollection:d,userData:b.userData};a.atTheEnd(f)}return c},g.EntityCollection.forEach=function(a,b){var c=this,d=(c._private,g.tools.handleArgs(arguments,0,{with3funcs:!0}));b=d.userData,a=d.options;var e={curelem:a.first||0,limit:a.limit||c.length,userData:b,entityCollection:c};g.EntityCollection.parseForEach(a,e)},g.EntityCollection.forEachInCache=function(a,b){var c=this,d=c._private,e=g.tools.handleArgs(arguments,0,{with3funcs:!0});b=e.userData,a=e.options;for(var f=!1,h=-1,i=d.pages.length,j=0,k=0,l=null,m=0,n=a.first||0,o=a.limit||c.length;!f;)if(j>=k?(++h,h>=i?f=!0:(l=d.pages[h],k=l.length,j=0,m=l.start)):++j,!f){var p=m+j;p>=n&&(o>p?c.getEntity(p,a,b,!0):f=!0)}},g.EntityCollection.add=function(a){null!=a&&(this._private.addedElems.push(a),this.length++)},g.EntityCollection.refresh=function(a,b){a=a||{},a.forceCollectionRefresh=!0;var c=0;null!=a.refreshCollectionFrom&&(c=a.refreshCollectionFrom),b=b,this.getEntity(c,a,b)},g.EntityCollection.toArray=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getName(),h.top=b.top||f.pageSize||40,h.skip=b.skip||null,h.params=f.params,h.addToSet=b.addToSet,h.retainPositions=b.retainPositions||null,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,h.orderby=b.orderby,h.autoExpand=a,h.asArray=!0,b.filterQuery&&(h.filter=b.filterQuery,h.params=b.params),h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,result:a,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.distinctValues=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getName(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=f.params,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,h.distinct=!0,null!=a&&(h.attributesRequested=[a]),h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,distinctValues:a,result:a,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.findKey=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getName(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=f.params,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,a instanceof Date&&(a=a.toISO()),h.findKey=a,h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,result:a.result,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.removeEntityReference=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options,b.removeReferenceOnly=!0,this.removeEntity(a,b,c)},g.EntityCollection.removeEntity=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;b.dataURI=f.dataURI;var h=e.getDataClass();if(!(a>=f.loadedElemsLength&&a<e.length)){b.pageSize=b.pageSize||f.pageSize,b.autoExpand=b.autoExpand||f.autoExpand,b.filterAttributes=b.filterAttributes||f.filterAttributes,f.updateOptions(b),b.removeAtPos=a,b.savedQuery=f.savedQuery||null,b.savedOrderby=f.savedOrderby||null;var i=new g.EntityCollection(h,null,b,c);return i}var j=a-f.loadedElemsLength,k=f.addedElems[j],l={entityCollection:e,result:e};null==k||null==k.getKey()||b.removeReferenceOnly?(f.addedElems.splice(j,1),e.length--,g.callHandler(!1,null,l,b,c)):k.remove({onSuccess:function(){f.addedElems.splice(j,1),e.length--,g.callHandler(!1,null,l,b,c)},onError:function(a){g.callHandler(!0,a.error,l,b,c)}})},g.EntityCollection.removeAllEntities=function(a,b){var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e=d._private;e.updateOptions(a);var f=new g.core.restConnect.restRequest(!0);f.entityCollection=d,f.resource=e.dataClass.getName(),f.addToSet=a.addToSet,f.params=e.params,f.progressInfo=a.progressInfo||e.progressInfo,f.savedOrderby=e.savedOrderby,f.savedQueryString=e.savedQuery,f.dataURI=e.dataURI,f.method="delete",f.atOnce=a.atOnce,f.handler=function(){if(4==f.http_request.readyState){var c=g.getRequestResult(f),e={entityCollection:d,XHR:f.http_request},h=null!=c.__ERROR;g.callHandler(h,c.__ERROR,e,a,b)}};f.go()},g.EntityCollection.buildFromSelection=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private,h=e.getDataClass();b.pageSize=b.pageSize||f.pageSize,b.autoExpand=b.autoExpand||f.autoExpand,b.filterAttributes=b.filterAttributes||f.filterAttributes,f.updateOptions(b),b.filterSet=e,b.fromSelection=a,b.savedQuery=f.savedQuery||null,b.savedOrderby=f.savedOrderby||null;var i=new g.EntityCollection(h,null,b,c);return i},g.EntityAttributeSimple=function(a,b,e){this.owner=a,this.value="date"==e.type&&"string"==typeof b?e.simpleDate?d(b):c(b):b,this.touched=!1,this.att=e,this.getValue=g.EntityAttributeSimple.getValue,this.setValue=g.EntityAttributeSimple.setValue,this.touch=g.EntityAttributeSimple.touch,this.isTouched=g.EntityAttributeSimple.isTouched,this.clearTouched=g.EntityAttributeSimple.clearTouched,this.getOldValue=g.EntityAttributeSimple.getOldValue,this.setRawValue=g.EntityAttributeSimple.setRawValue,this.getRawValue=g.EntityAttributeSimple.getRawValue},g.EntityAttributeSimple.getValue=function(){return this.value},g.EntityAttributeSimple.setValue=function(a){void 0===this.oldValue&&(this.oldValue=this.value),this.value=a,this.touch()},g.EntityAttributeSimple.touch=function(){this.touched=!0,this.owner.touch()},g.EntityAttributeSimple.clearTouched=function(){this.touched=!1},g.EntityAttributeSimple.isTouched=function(){return this.touched},g.EntityAttributeSimple.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},g.EntityAttributeSimple.setRawValue=function(a){this.value="date"===this.att.type&&"string"==typeof a?this.att.simpleDate?d(a):c(a):a,delete this.oldValue},g.EntityAttributeSimple.getRawValue=function(){var a=this.value;return null!=a&&"date"==this.att.type&&(a=this.att.simpleDate?a.toSimpleDateString():a.toISO()),a},g.EntityAttributeRelated=function(a,b,c){if(g.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntity=null,this.dataURI=b.__deferred.uri,this.relKey=b.__deferred.__KEY;else{var d=c.getRelatedClass();null==d?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new g.Entity(d,b,{getRefFromCache:!0}),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;this.setValue=g.EntityAttributeRelated.setValue,this.getValue=g.EntityAttributeRelated.getValue,this.load=this.getValue,this.setRawValue=g.EntityAttributeRelated.setRawValue,this.getRawValue=g.EntityAttributeRelated.getRawValue,this.getOldValue=g.EntityAttributeRelated.getOldValue,this.getRelatedKey=g.EntityAttributeRelated.getRelatedKey},g.EntityAttributeRelated.getRelatedKey=function(){var a=null;return a=null==this.relEntity?this.relKey:this.relEntity.getKey()},g.EntityAttributeRelated.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},g.EntityAttributeRelated.getValue=function(a,b){if(null==a)return this.relEntity;var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e={entity:null};if(null==d.relEntity)if(null==d.dataURI&&null==d.relKey)g.callHandler(!1,null,e,a,b);else{var f=d.att.getRelatedClass();null==f?g.callHandler(!1,null,e,a,b):null!=d.relKey?f.getEntity(d.relKey,{onSuccess:function(c){d.relEntity=c.entity,g.callHandler(!1,null,c,a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand}):f.getEntityByURI(d.dataURI,{onSuccess:function(c){d.relEntity=c.entity,g.callHandler(!1,null,c,a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand})}else e.entity=d.relEntity,g.callHandler(!1,null,e,a,b)},g.EntityAttributeRelated.setValue=function(a){void 0===this.oldValue&&(this.oldValue=this.relEntity),this.relEntity=a,this.touched=!0,this.owner.touch(),this.dataURI=null,null==a?this.relKey=null:a instanceof g.Entity?this.relKey=a.getKey():this.relKey!==a&&(this.relEntity=null,this.relKey=a)},g.EntityAttributeRelated.setRawValue=function(a){if(null!=a)if(null!=a.__deferred)this.relEntity=null,this.dataURI=a.__deferred.uri,this.relKey=a.__deferred.__KEY;else{var b=this.att.getRelatedClass();null==b?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new g.Entity(b,a,{getRefFromCache:!0}),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;delete this.oldValue},g.EntityAttributeRelated.getRawValue=function(){var a=this.relEntity;if(null!=a){var b=a.getKey();a=null!=b?{__KEY:b}:a._private.getRESTFormat()}return a},g.EntityAttributeRelatedSet=function(a,b,c){if(g.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntityCollection=null,this.dataURI=b.__deferred.uri;else{var d=c.getRelatedClass();null==d?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new g.EntityCollection(d,null,{prefetchedData:b}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null;this.setValue=g.EntityAttributeRelatedSet.setValue,this.getValue=g.EntityAttributeRelatedSet.getValue,this.setRawValue=g.EntityAttributeRelatedSet.setRawValue},g.EntityAttributeRelatedSet.setRawValue=function(a){if(null!=a)if(null!=this.dataURI&&a.__deferred==this.dataURI);else if(null!=a.__deferred)this.relEntityCollection=null,this.dataURI=a.__deferred.uri;else{var b=this.att.getRelatedClass();null==b?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new g.EntityCollection(b,null,{prefetchedData:a}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null},g.EntityAttributeRelatedSet.getValue=function(a,b){if(null==a)return this.relEntityCollection;var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=null,e={entityCollection:null};if(null!=this.relEntityCollection)if(d=this.relEntityCollection,d._private.ready)e.entityCollection=d,g.callHandler(!1,null,e,a,b);else{var f=function(){d._private.ready?(e.entityCollection=d,g.callHandler(!1,null,e,a,b)):setTimeout(f,100)};setTimeout(f,100)}else{var h=this.att.getRelatedClass();null==h?g.callHandler(!0,{error:601,errorMessage:"wrong entityCollection reference"},e,a,b):(null==this.dataURI&&(this.dataURI="*"),a.isARelatedEntityCollection=!0,a.dataURI=this.dataURI,this.relEntityCollection=new g.EntityCollection(h,null,a,b),d=this.relEntityCollection)}return d},g.Entity=function(a,b,c){var d=this;c=c||{};var e,f,h=(c.getRefFromCache||!1)&&a.mustCacheRef(),i=null;if(h&&null!=b&&(e=a.getRefCache(),f=b.__KEY,null!=f&&(i=e.getCacheInfo(f),null!=i&&b.__STAMP===i.entity.getStamp())))return i.timeStamp=new Date,d=i.entity;this._private={touched:!1,isNew:!0,dataClass:a,owner:this,values:{},methodRefs:a._private.entityMethodRefs,methods:a._private.entityMethods,getRESTFormat:g.Entity.getRESTFormat};var j=this._private,k=j.methods;for(var l in k)d[l]=k[l];this.touch=g.Entity.touch,this.getDataClass=g.Entity.getDataClass,this.getKey=g.Entity.getKey,this.setStamp=g.Entity.setStamp,this.setKey=g.Entity.setKey,this.getStamp=g.Entity.getStamp,this.callMethod=g.Entity.callMethod,this.isNew=g.Entity.isNew,this.isTouched=g.Entity.isTouched,this.save=g.Entity.save,this.remove=g.Entity.remove,this.lock=g.Entity.lock,this.unlock=g.Entity.unlock,this._dolock=g.Entity._dolock,this.serverRefresh=g.Entity.serverRefresh;var m=!1;null==b||null==b.__KEY?(this._private.key=null,this._private.stamp=0,this._private.isNew=!0,m=!0,null!=b&&(this._private.touched=!0)):(this._private.key=b.__KEY,this._private.stamp=b.__STAMP,this._private.isNew=!1);var n=d._private.values,o=a._private.attributesByName;for(var l in o){var p,q=o[l],r=null==b?null:null==b[l]?null:b[l];p=q.related?q.relatedOne?new g.EntityAttributeRelated(d,r,q):new g.EntityAttributeRelatedSet(d,r,q):new g.EntityAttributeSimple(d,r,q),m&&null!=r&&(p.touched=!0),n[l]=p,d[l]=p}return h&&null!=b&&(e.setEntry(d),null!=i)?i.entity:void 0},g.Entity.getRESTFormat=function(a){var b=this,c=this.owner,d={},e=c.getKey();null!=e?(d.__KEY=e,d.__STAMP=c.getStamp(),a&&(d.__STAMP=-d.__STAMP)):d.__ISNEW=!0;for(var f in b.values){var g=b.values[f];g.isTouched()&&(d[f]=g.getRawValue())}return d},g.Entity.touch=function(){this._private.touched=!0},g.Entity.getDataClass=function(){return this._private.dataClass},g.Entity.getKey=function(){return this._private.key},g.Entity.getStamp=function(){return this._private.stamp},g.Entity.setKey=function(a){this._private.key=a},g.Entity.setStamp=function(a){this._private.stamp=a},g.Entity.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,f=arguments.length;f>e;e++)d.push(arguments[e]);return g.DataStore.funcCaller(c,b,d,a)}},g.Entity.isNew=function(){return this._private.isNew},g.Entity.isTouched=function(){return this._private.touched},g.Entity.serverRefresh=function(a,b){var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options,a.refreshOnly=!0,this.save(a,b)},g.Entity.lock=function(a,b){this._dolock(!0,a||null,b||null)},g.Entity.unlock=function(a,b){this._dolock(!1,a||null,b||null)},g.Entity._dolock=function(a,b){var c=this,d=g.tools.handleArgs(arguments,1);userData=d.userData,b=d.options;var e=c.getDataClass(),f=e.getName(),h=c.getKey(),i=new g.core.restConnect.restRequest(!0);i.resource=f+"("+h+")",i.mustlock=a,i.handler=function(){if(4==i.http_request.readyState){var a=!1,d=!1,e=null,f=g.getRequestResult(i);null!=f.__ERROR?(d=!0,e=f.__ERROR):a=f.result;var h={entity:c,result:a};g.callHandler(d,e,h,b,userData)}};i.go()},g.Entity.remove=function(a,b){var c=this,d=g.tools.handleArgs(arguments,0);b=d.userData,a=d.options;var e=c.getDataClass(),f=e.getName(),h=c.getKey(),i=new g.core.restConnect.restRequest(!0);i.resource=f+"("+h+")",i.method="delete",i.handler=function(){if(4==i.http_request.readyState){var d=!1,f=null,j=g.getRequestResult(i);null!=j.__ERROR?(d=!0,f=j.__ERROR):e.getCache().removeCachedEntity(h);var k={entity:c};g.callHandler(d,f,k,a,b)}};i.go()},g.Entity.save=function(a,b){var c=this,d=g.tools.handleArgs(arguments,0);b=d.userData,a=d.options;var e=c.getDataClass(),f=e.getName(),h=a.refreshOnly;null==h&&(h=!1);var i=new g.core.restConnect.restRequest(!0);i.resource=f;var j=c.getKey();null==j?(i.method="update",i.httpMethod=g.core.restConnect.httpMethods._post):(i.method="update",i.httpMethod=g.core.restConnect.httpMethods._post),i.postdata='{ "__ENTITIES": ['+JSON.stringify(c._private.getRESTFormat(a.overrideStamp))+"]}",i.refreshOnly=h,null!=a.autoExpand&&(i.autoExpand=a.autoExpand),null!=a.filterAttributes&&(i.filterAttributes=a.filterAttributes),i.handler=function(){if(4==i.http_request.readyState){var d=g.getRequestResult(i),f={entity:c,rawResult:d,XHR:i.http_request},d=JSON.parse(i.http_request.responseText),j=!1,k=null;if(d&&d.__ENTITIES&&d.__ENTITIES[0]){var l=d.__ENTITIES[0];if(l.__ERROR)k=l.__ERROR,j=!0;else{var m=l.__KEY;h||(null!=m&&(c._private.key=m),c._private.stamp=l.__STAMP);var n=e._private.attributesByName;for(var o in n){var p=n[o],q=l[o];void 0===q&&(q=null);var r=c[o];null==r?(r=p.related?p.relatedOne?new g.EntityAttributeRelated(c,q,p):new g.EntityAttributeRelatedSet(c,q,p):new g.EntityAttributeSimple(c,q,p),c[o]=r):(r.setRawValue(q),h||r.clearTouched())}e.mustCacheRef()?e.getRefCache().setEntry(c):e.getCache().replaceCachedEntity(m,l),h||(c._private.touched=!1,c._private.isNew=!1)}}g.callHandler(j,k,f,a,b)}};i.go()},g.EntityCollection.prototype.getDataClass=g.EntityCollection.getDataClass,g.EntityCollection.prototype.query=g.EntityCollection.query,g.EntityCollection.prototype.getEntity=g.EntityCollection.getEntity,g.EntityCollection.prototype.getEntities=g.EntityCollection.getEntities,g.EntityCollection.prototype.callMethod=g.EntityCollection.callMethod,g.EntityCollection.prototype.each=g.EntityCollection.forEach,g.EntityCollection.prototype.forEach=g.EntityCollection.forEach,g.EntityCollection.prototype.forEachInCache=g.EntityCollection.forEachInCache,g.EntityCollection.prototype.add=g.EntityCollection.add,g.EntityCollection.prototype.orderBy=g.EntityCollection.orderBy,g.EntityCollection.prototype.toArray=g.EntityCollection.toArray,g.EntityCollection.prototype.distinctValues=g.EntityCollection.distinctValues,g.EntityCollection.prototype.findKey=g.EntityCollection.findKey,g.EntityCollection.prototype.removeEntity=g.EntityCollection.removeEntity,g.EntityCollection.prototype.removeEntityReference=g.EntityCollection.removeEntityReference,g.EntityCollection.prototype.removeAllEntities=g.EntityCollection.removeAllEntities,g.EntityCollection.prototype.buildFromSelection=g.EntityCollection.buildFromSelection,g.EntityCollection.prototype.getReference=g.EntityCollection.getReference,g.EntityCollection.prototype.refresh=g.EntityCollection.refresh,g.DataClass.prototype.distinctValues=g.DataClass.distinctValues,g.DataClass.prototype.all=g.DataClass.allEntities,g.DataClass.prototype.allEntities=g.DataClass.allEntities,g.DataClass.prototype.query=g.DataClass.query,g.DataClass.prototype.find=g.DataClass.find,g.DataClass.prototype.getAttributeByName=g.DataClass.getAttributeByName,g.DataClass.prototype.getAttributes=g.DataClass.getAttributes,g.DataClass.prototype.getMethodList=g.DataClass.getMethodList,g.DataClass.prototype.getCache=g.DataClass.getCache,g.DataClass.prototype.getRefCache=g.DataClass.getRefCache,g.DataClass.prototype.getCacheSize=g.DataClass.getCacheSize,g.DataClass.prototype.setCacheSize=g.DataClass.setCacheSize,g.DataClass.prototype.clearCache=g.DataClass.clearCache,g.DataClass.prototype.newEntity=g.DataClass.newEntity,g.DataClass.prototype.getEntity=g.DataClass.getEntity,g.DataClass.prototype.getEntityByURI=g.DataClass.getEntityByURI,g.DataClass.prototype.getDataStore=g.DataClass.getDataStore,g.DataClass.prototype.getCollectionName=g.DataClass.getCollectionName,g.DataClass.prototype.getDefaultTopSize=g.DataClass.getDefaultTopSize,g.DataClass.prototype.getName=g.DataClass.getName,g.DataClass.prototype.newCollection=g.DataClass.newCollection,g.DataClass.prototype.toArray=g.DataClass.toArray,g.DataClass.prototype.mustCacheRef=g.DataClass.mustCacheRef,g.DataClass.prototype.callMethod=g.DataStore.callMethod,g.directory=g.directory||{},g.directory.login=g.DataStore.makeFuncCaller({name:"login",applyTo:"general",nameSpace:"$directory"}),g.directory.loginByPassword=g.directory.login,g.directory.logout=g.DataStore.makeFuncCaller({name:"logout",applyTo:"general",nameSpace:"$directory"}),g.directory.loginByKey=g.DataStore.makeFuncCaller({name:"loginByKey",applyTo:"general",nameSpace:"$directory"}),g.directory.currentUser=g.DataStore.makeFuncCaller({name:"currentUser",applyTo:"general",nameSpace:"$directory"}),g.directory.currentUserBelongsTo=g.DataStore.makeFuncCaller({name:"currentUserBelongsTo",applyTo:"general",nameSpace:"$directory"}),g.dsExport=g.dsExport||{},g.dsExport.exportData=g.DataStore.makeFuncCaller({name:"exportData",applyTo:"general",nameSpace:"$impexp"});var h=angular.module("wakanda",[]);h.factory("$wakanda",["$q","$rootScope","$http",function(a,b,c){var d=null,e={},h=40,i=300,j=3,k=function(b){var c=a.defer();return("string"!=typeof b||"*"===b||""===b)&&(b=null),null===d?new g.DataStore({onSuccess:function(a){d=a.dataStore,o.wafDatastore(d),o.wafDataClasses(d),c.resolve(d)},onError:function(a){d=null,c.reject(a)},catalog:b}):c.resolve(d),c.promise},l=function(){if(null!==d)return d;throw new Error("The Datastore isn't initialized please execute .init(catalog) before you run your app.")},m=function(a){var c=b.$$phase;"$apply"===c||"$digest"===c?a&&"function"==typeof a&&a():b.$apply(a)},n={shallowClearAndCopy:function(a,b){b=b||{},angular.forEach(b,function(a,c){delete b[c]});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}},o={wafDatastore:function(a){a.$Entity=F.prototype},wafDataClasses:function(a){var b;g.DataClass.prototype.$find=C,g.DataClass.prototype.$findOne=D,g.DataClass.prototype.$create=r;for(b in a)a.hasOwnProperty(b)&&"_private"!==b&&/^\$.*/.test(b)===!1&&(o.wafDataClassAddMetas(a[b]),o.wafDataClassAddDataClassMethods(a[b]),o.wafDataClassCreateNgWakEntityClasses(a[b]),o.wafDataClassCreateRefCache(a[b]))},wafDataClassAddMetas:function(a){var b,c,d=[],e=[],f=[];angular.forEach(a.getMethodList(),function(a){switch(a.applyTo){case"entity":f.push(a.name);break;case"entityCollection":e.push(a.name);break;case"dataClass":d.push(a.name)}}),b=a._private.attributesByName,a.$attr=function(a){return"undefined"==typeof a?b:a&&b[a]?b[a]:null},a.$dataClassMethods=function(){return d},a.$collectionMethods=function(){return e},a.$entityMethods=function(){return f},a.$name=a.getName(),a.$collectionName=a.getCollectionName();for(c in b)b[c].identifying===!0&&(a.$_identifyingAttr=b[c])},wafDataClassAddDataClassMethods:function(a){p.createUserDefinedDataClassMethods(a)},wafDataClassCreateNgWakEntityClasses:function(a){var b;b=p.createUserDefinedEntityMethods(a),e[a.getName()]=F.extend(b),d[a.getName()].$Entity=e[a.getName()].prototype},wafDataClassCreateRefCache:function(a){a.$refCache=new G}},p={createUserDefinedEntityMethods:function(a){var b,c={};for(b in a._private.entityMethods)a._private.entityMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_entity[b].apply(this.$_entity,arguments)},p.wakandaUserDefinedMethodToPromisableMethods(c,b,a._private.entityMethods[b]));return c},createUserDefinedEntityCollectionMethods:function(a){var b,c={};for(b in a._private.entityCollectionMethods)a._private.entityCollectionMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_collection[b].apply(this.$_collection,arguments)},p.wakandaUserDefinedMethodToPromisableMethods(c,b,a._private.entityCollectionMethods[b]));return c},createUserDefinedDataClassMethods:function(b){angular.forEach(b.$dataClassMethods(),function(c){b[c]=function(){var d=a.defer();return b.callMethod({method:c,onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)},arguments:arguments.length>0?Array.prototype.slice.call(arguments,0):[]}),d.promise},b[c+"Sync"]=function(){return b.callMethod({method:c,sync:!0,arguments:arguments.length>0?Array.prototype.slice.call(arguments,0):[]})}})},wakandaUserDefinedMethodToPromisableMethods:function(b,c,d){b[c]=function(){var b,c,e,f=[],h={};if(this instanceof F){if("undefined"==typeof this.$_entity||!this.$_entity instanceof g.Entity)throw new Error("Calling user defined method on unfetched entity, please call $fetch before or retrieve data on $find");c="$_entity"}else c="$_collection";if(arguments.length>0)for(var i=0;i<arguments.length;i++)f.push(arguments[i]);"$_entity"===c&&this.$syncPojoToEntity(),e=a.defer();var b=this;if(h.onSuccess=function(a){m(function(){"$_entity"===c&&b.$syncEntityToPojo(),e.resolve(a)})},h.onError=function(a){m(function(){e.reject(a)})},f.unshift(h),"$_entity"===c)d.apply(this[c],f);else{if(!this.$_collection)throw new Error("Couldn't call user defined method on collection because no pointer on this collection");d.apply(this[c],f)}return e.promise}}},q=(window.collectionToNgWakEntityCollection=function(a,b){b="undefined"==typeof b?{}:b;{var c=("undefined"==typeof b.result?[]:b.result,"undefined"==typeof b.start?0:b.start),d="undefined"==typeof b.pageSize?h:b.pageSize;a.getDataClass()}a.forEachInCache({onSuccess:function(a){},first:c,limit:c+d})},{queryEventToNgWakEntityCollection:function(a,b){var c,d,e;return d=JSON.parse(a.XHR.response),c=d.__ENTITIES,e=q.jsonResponseToNgWakEntityCollection(a.result.getDataClass(),c),b!==!0?e.$_collection=a.result:e=1===e.length?e[0]:null,a.result=e,a},jsonResponseToNgWakEntityCollection:function(a,b){var c=[];return b.map(function(b){c.push(a.$create(b))}),c},fetchEventToNgWakEntityCollection:function(a){var b=[],c=a.result._private.dataClass;a.entities.forEach(function(a){b.push(c.$create(a))}),a.result=b},asyncResult:function(a,b,c){a instanceof Array?(b.length=0,angular.forEach(a,function(a){b.push(a)}),b.$_collection=a.$_collection,q.addFrameworkMethodsToRootCollection(b),q.addUserDefinedMethodsToCollection(b,!0),b.$promise=c):("undefined"==typeof b.$_entity&&"undefined"!=typeof a.$_entity&&(b.$_entity=a.$_entity),n.shallowClearAndCopy(a,b),b.$promise=c)},addUserDefinedMethodsToCollection:function(a,b){var c,d=null;if(b===!0?"undefined"!=typeof a.$_collection&&(d=a.$_collection.getDataClass()):b===!1&&"undefined"!=typeof a.$_collection&&"undefined"!==a.$_collection.relEntityCollection&&(d=a.$_collection.relEntityCollection),null===d)return a;c=p.createUserDefinedEntityCollectionMethods(d);for(var e in c)c.hasOwnProperty(e)&&(a[e]=c[e]);return a},addFrameworkMethodsToRootCollection:function(a){a.$fetch=x,a.$add=B,a.$more=y,a.$nextPage=z,a.$prevPage=A,a.$totalCount=a.$_collection.length,a.$toJSON=$$toJSON},addFrameworkMethodsToNestedCollection:function(a){a.$fetch=v,a.$more=y,a.$nextPage=z,a.$prevPage=A,a.$toJSON=$$toJSON,a.$isLoaded=$$isLoadedOnNestedCollection,a.$totalCount=null}}),r=function(a){var b,c=this.getName();return a="undefined"==typeof a?{}:a,b=new e[c],s(a,b,this),b},s=function(a,b,c){var f,h,i,j=c.$attr(),k=a instanceof g.Entity,l={uri:"src"};if(null!==a&&"undefined"!=typeof a){k===!1?a.__deferred?b.$_deferred={uri:a.__deferred.uri,dataClass:c}:a.value&&a.value.__deferred?b.$_deferred={uri:a.value.__deferred.uri,dataClass:c}:b.$_entity=new g.Entity(c,a):b.$_entity=a,k?(b.__KEY=a.getKey(),b.__STAMP=a.getStamp()):("undefined"!=typeof a.__KEY&&(b.__KEY=a.__KEY),"undefined"!=typeof a.__STAMP&&(b.__STAMP=a.__STAMP));for(f in j)if("undefined"!=typeof a[f])if("storage"===j[f].kind||"calculated"===j[f].kind||"alias"===j[f].kind)if("image"===j[f].type){if(b[f]={},i=k?a[f].getValue():a[f],i&&i.__deferred)for(h in i.__deferred)b[f][l[h]?l[h]:h]=i.__deferred[h];else b[f][l.uri]=null;b[f].$upload=t}else k?b[f]=a[f].getValue():"undefined"!=typeof a[f]&&(b[f]=k?a[f].getValue():a[f],"date"===j[f].type&&null!==b[f]&&b[f]instanceof Date==!1&&(b[f]=new Date(b[f])));else"relatedEntities"===j[f].kind?(a[f].__ENTITIES?(b[f]=q.jsonResponseToNgWakEntityCollection(j[f].getRelatedClass(),a[f].__ENTITIES),q.addFrameworkMethodsToNestedCollection(b[f])):a[f].__deferred&&(b[f]=[],b[f].$_deferred={uri:a[f].__deferred.uri,dataClass:j[f].getRelatedClass(),attr:f},q.addFrameworkMethodsToNestedCollection(b[f])),b[f]&&(b[f].$_collection=b.$_entity[f])):"relatedEntity"===j[f].kind&&(b[f]=new(e[k&&a[f].relEntity?a[f].relEntity.getDataClass().$name:d[c.$name].$attr(f).type]),k&&null!==a[f].relEntity?s(a[f].relEntity,b[f],a[f].relEntity.getDataClass()):s(a[f],b[f],d[d[c.$name].$attr(f).type]))}},t=function(){},u=function(a,b,c){"undefined"==typeof a.$query&&(a.$query={}),a.$query.pageSize=b,a.$query.start=c},v=function(b,c){var d=this,e=a.defer(),f={};return c="undefined"==typeof c||"replace"===c?"replace":c,d.$_collection?(b||(b={}),"undefined"!=typeof b.orderBy,"undefined"!=typeof b.select,f.skip=b.start="undefined"==typeof b.start?this.$query?this.$query.start:0:b.start,f.top=b.pageSize="undefined"==typeof b.pageSize?this.$query?this.$query.pageSize:h:b.pageSize,b.select&&(f.autoExpand=b.select),b.orderBy&&(f.orderby=b.orderBy),m(function(){d.$fetching=!0
}),f.onSuccess=function(a){m(function(){"replace"===c&&(d.length=0),a.entityCollection.forEach({onSuccess:function(a){m(function(){d.push(d.$_collection.relEntityCollection.getDataClass().$create(a.entity))})},atTheEnd:function(a){},first:f.skip,limit:f.skip+f.top}),delete d.$_deferred,u(d,b.pageSize,b.start),d.$totalCount=a.entityCollection.length,d.$fetching=!1,e.resolve(d)})},f.onError=function(a){m(function(){d.$fetching=!1,e.reject(a)})},d.$_collection.getValue(f)):e.reject("Missing $_collection private pointer (WAF.EntityAttributeRelatedSet), check if you used $find or $fetch to load the collection"),e.promise};$$isLoadedOnNestedCollection=function(){return this.$_deferred?!1:!0};var w=function(a,b,c,d){"undefined"==typeof a.$query&&(a.$query={}),a.$query.pageSize=b,a.$query.start=c,a.$query.filter=d?d:a.$query.filter},x=function(b,c){var d,e,f,g={},h=this;if(c="undefined"==typeof c||"replace"===c?"replace":c,b||(b={}),"undefined"!=typeof b.orderBy)throw new Error("orderBy can't be change on a $fetch (query collection's cached on server side)");if("undefined"!=typeof b.select)throw new Error("select can't be change on a $fetch (query collection's cached on server side)");e=b.start="undefined"==typeof b.start?this.$query.start:b.start,f=b.pageSize=b.pageSize||this.$query.pageSize,b.params&&(g.params=b.params),d=a.defer();var h=this;return m(function(){h.$fetching=!0}),g.onSuccess=function(a){m(function(){if(q.fetchEventToNgWakEntityCollection(a),"replace"===c){h.length=0;for(var f=0;f<a.result.length;f++)h[f]=a.result[f]}else if("append"===c)for(var f=0;f<a.result.length;f++)h.push(a.result[f]);w(h,b.pageSize||h.$_collection._private.pageSize,e),h.$fetching=!1,d.resolve(a)})},g.onError=function(a){m(function(){h.$fetching=!1,d.reject(a)})},this.$_collection.getEntities(e,f,g),d.promise};$$toJSON=function(){var a=function(b){var c,d,e;if(b instanceof Array){if(c=[],b.length>0)for(e=0;e<b.length;e++)c.push(a(b[e]))}else{c={};for(d in b)b.hasOwnProperty(d)&&"$_entity"!==d&&"$_deferred"!==d&&(b[d]instanceof Array||b[d]instanceof F?c[d]=a(b[d]):null===b[d]||"undefined"==typeof b[d]||b[d].$_deferred||(c[d]=b[d]))}return c},b=a(this);return JSON.stringify(b)};var y=function(){var b,c,d,e;return"undefined"!=typeof this.$query?(b=this.$query.start+this.$query.pageSize,c=this.$query.pageSize,d=this.$totalCount):(b=0,c=h,d=h),b>=d?(e=new a.defer,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c},"append")},z=function(){var b,c,d,e;return"undefined"!=typeof this.$query?(b=this.$query.start+this.$query.pageSize,c=this.$query.pageSize,d=this.$totalCount):(b=0,c=h,d=h),b>=d?(e=new a.defer,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c})},A=function(){var b,c,d,e;return"undefined"==typeof this.$query?(d=new a.defer,d.reject(new Error("No collection fetched to $prevPage() on.")),d.promise):(b=this.$query.start-this.$query.pageSize,c=this.$query.pageSize,0>b&&(e=!0,b=0),this.$fetch({start:b,pageSize:c}).then(function(a){return e===!0&&(a.noMore=!0),a}))},B=function(){},C=function(b){var c,d,f,g={},h=null;return b&&"object"==typeof b||(b={}),b.select&&(g.autoExpand=b.select),b.filter&&(h=b.filter),b.params&&(g.params=b.params),b.orderBy&&(g.orderby=b.orderBy),"undefined"!=typeof b.pageSize&&(g.pageSize=b.pageSize),d=!!b.onlyOne,f=d?new e[this.$name]:[],c=a.defer(),f.$promise=c.promise,m(function(){f.$fetching=!0}),g.onSuccess=function(a){m(function(){q.queryEventToNgWakEntityCollection(a,d),q.asyncResult(a.result,f,c.promise),d===!1&&w(f,f.$_collection._private.pageSize,0,h),f.$fetching=!1,a.result=f,c.resolve(a)})},g.onError=function(a){m(function(){f.$fetching=!1,c.reject(a)})},b=null,this.query(h,g),f},D=function(a,b){return b="undefined"==typeof b?{}:b,b.filter=this.$_identifyingAttr.name+" = "+a,b.onlyOne=!0,this.$find(b)},E={init:function(){Object.defineProperty(this,"$_entity",{enumerable:!1,configurable:!1,writable:!0})},$save:function(){var b,c={},d=this;return this.$syncPojoToEntity(),b=a.defer(),c.onSuccess=function(a){m(function(){d.$syncEntityToPojo(),b.resolve(a)})},c.onError=function(a){m(function(){b.reject(a)})},this.$_entity.save(c),b.promise},$remove:function(){var b,c={};return b=a.defer(),c.onSuccess=function(a){m(function(){b.resolve(a)})},c.onError=function(a){m(function(){b.reject(a)})},this.$_entity.remove(c),b.promise},$syncPojoToEntity:function(){var a,b=this;if(b.$_entity&&b.$_entity._private&&b.$_entity._private.values)for(a in b.$_entity._private.values)b.$_entity[a].getValue()!==b[a]&&b.$_entity[a]instanceof g.EntityAttributeSimple&&b.$_entity[a].setValue(b[a])},$syncEntityToPojo:function(){var a,b=this;if(b.$_entity&&b.$_entity._private&&b.$_entity._private.values)for(a in b.$_entity._private.values)b.$_entity[a].getValue()!==b[a]&&b.$_entity[a]instanceof g.EntityAttributeSimple&&(b[a]=b.$_entity[a].getValue());b.__KEY=b.$_entity.getKey(),b.__STAMP=b.$_entity.getStamp()},$fetch:function(){var b,d,e=this,f={};if(b=a.defer(),this.$_entity)return f.onSuccess=function(a){m(function(){d=e.$_entity.getDataClass().$create(a.entity);for(var c in d)d.hasOwnProperty(c)&&(e[c]=d[c]);b.resolve(d)})},f.onError=function(a){m(function(){b.reject("$fetch > Error while serverRefresh"+a)})},this.$_entity.serverRefresh(f),b.promise;if(!this.$_deferred)throw new Error("Couldn't fetch, an error occured, no $_entity or $_deferred");return c({method:"GET",url:this.$_deferred.uri}).success(function(a){d=e.$_deferred.dataClass.$create(a);for(var c in d)d.hasOwnProperty(c)&&(e[c]=d[c]);delete e.$_deferred,b.resolve(d)}).error(function(a,c){b.reject("$fetch > Error while fetching deferred entity"+a)}),b.promise},$isLoaded:function(){return this.$_entity?!0:!1},$toJSON:$$toJSON},F=f.extend(E),G=function(a){a="undefined"==typeof a?{}:a,this.maxEntities=a.maxEntities||i,this.deep=a.deep||j,this.infos={},this.nbEntries=0};G.prototype.setSize=function(a){(null===a||i>a)&&(a=i),this.maxEntities=a},G.prototype.setDeep=function(a){this.deep=a},G.prototype.getCacheInfo=function(a){return this.infos[a]||null},G.prototype.replaceCachedEntity=function(a,b){var c=this.getCacheInfo(a);null!==c&&b.__STAMP>c.__STAMP&&(c=b)};var H=function(b,c){var d,e={};return d=a.defer(),e.onSuccess=function(a){d.resolve({result:a.result})},e.onError=function(a){d.reject(a)},g.directory.loginByPassword(b,c,e),d.promise},I=function(){var b,c={};return b=a.defer(),c.onSuccess=function(a){b.resolve({result:a.result})},c.onError=function(a){b.reject(a)},g.directory.currentUser(c),b.promise},J=function(){var b,c={};return b=a.defer(),c.onSuccess=function(a){b.resolve({result:a.result})},c.onError=function(a){b.reject(a)},g.directory.logout(c),b.promise},K=function(b){var c,d={};return c=a.defer(),d.onSuccess=function(a){c.resolve({result:a.result})},d.onError=function(a){c.reject(a)},g.directory.currentUserBelongsTo(b,d),c.promise},L={init:k,getDatastore:l,$login:H,$loginByPassword:H,$currentUser:I,$logout:J,$currentUserBelongsTo:K};return Object.defineProperty(L,"$ds",{get:l}),L}])}({},function(){return this}());